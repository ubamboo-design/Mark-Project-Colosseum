<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
<title>PROJECT CAGE : RELOADED v16.9 (Currency Fixed)</title>
<style>
    /* æ­¤è™•å®Œå…¨ä¿ç•™ v16.8 CSSï¼Œå…§å®¹éé•·åƒ…å±•ç¤ºé—œéµ root */
    :root {
        --bg: #050505; --card: #0a0a0c; --bar: #1a1a1e; --text: #e0e0e0; --mute: #888;
        --tw: #ff2a2a; --us: #00d2ff; --yield: #00ff6a; --ber: #ff9100; --trap: #bd00ff; 
        --gold: #ffd700; --red: #ff2a2a; --green: #00ff6a; --cyan: #00f7ff; --emergency: #ff0000;
        --hud-cyan: #00eaff; --hud-green: #00ff4c; --hud-gold: #ffcc00;
        --font-tech: 'Orbitron', sans-serif; --font-num: 'Rajdhani', sans-serif;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { background: #000; background-image: linear-gradient(rgba(0, 20, 30, 0.9), rgba(0, 5, 10, 1)), linear-gradient(0deg, transparent 24%, rgba(0, 255, 255, .05) 25%, rgba(0, 255, 255, .05) 26%, transparent 27%, transparent 74%, rgba(0, 255, 255, .05) 75%, rgba(0, 255, 255, .05) 76%, transparent 77%, transparent), linear-gradient(90deg, transparent 24%, rgba(0, 255, 255, .05) 25%, rgba(0, 255, 255, .05) 26%, transparent 27%, transparent 74%, rgba(0, 255, 255, .05) 75%, rgba(0, 255, 255, .05) 76%, transparent 77%, transparent); background-size: 100% 100%, 50px 50px, 50px 50px; color: var(--text); font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; line-height: 1.3; overflow-x: hidden; padding-bottom: 30px; overscroll-behavior-y: contain; }
    #refresh-indicator { position: fixed; top: 0; left: 0; width: 100%; height: 0; background: rgba(0, 247, 255, 0.1); display: flex; justify-content: center; align-items: center; overflow: hidden; transition: height 0.2s; z-index: 9999; pointer-events: none; backdrop-filter: blur(5px); border-bottom: 1px solid var(--cyan); }
    .refresh-text { font-family: var(--font-tech); font-weight: 900; color: var(--cyan); font-size: 1.2rem; letter-spacing: 3px; text-shadow: 0 0 10px var(--cyan); display: flex; align-items: center; gap: 10px; }
    .spinner { width: 20px; height: 20px; border: 3px solid rgba(0,247,255,0.3); border-radius: 50%; border-top-color: var(--cyan); animation: spin 1s infinite; display: none; }
    @keyframes spin { to { transform: rotate(360deg); } }
    header { padding: 15px 20px 5px 20px; background: transparent; position: relative; display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 10px; }
    #pageLogo { height: 50px; width: auto; object-fit: contain; display: none; filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.4)); }
    .header-text { text-align: left; display: flex; flex-direction: column; justify-content: center; }
    h1 { font-size: 1.6rem; letter-spacing: 3px; text-transform: uppercase; color: #fff; text-shadow: 0 0 15px rgba(255,255,255,0.2); font-weight: 900; margin: 0; font-family: var(--font-tech); line-height: 1; }
    .meta-info { font-family: 'Courier New', monospace; color: var(--gold); margin-top: 4px; font-size: 0.75rem; opacity: 0.8; letter-spacing: 1px; }
    .container { max-width: 1600px; margin: 0 auto; padding: 0 10px; }
    .dashboard-wrapper { margin-top: 20px; padding: 15px; background: linear-gradient(180deg, #2a2a30 0%, #1a1a1e 100%); border: 1px solid #444; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.8); position: relative; }
    .dash-grid { display: grid; grid-template-columns: 1fr 1fr 1.4fr; gap: 8px; background: #000; padding: 5px; border-radius: 4px; } 
    .hud-screen { position: relative; padding: 20px 15px; display: flex; flex-direction: column; justify-content: space-between; overflow: hidden; box-shadow: inset 0 0 30px rgba(0,0,0,0.9); min-height: 180px; }
    .hud-screen.cyan { background-color: rgba(0, 20, 30, 0.9); border: 1px solid rgba(0, 234, 255, 0.2); }
    .hud-screen.cyan .hud-title { color: var(--hud-cyan); text-shadow: 0 0 15px var(--hud-cyan); border-bottom: 2px solid var(--hud-cyan); }
    .hud-screen.green { background-color: rgba(0, 30, 10, 0.9); border: 1px solid rgba(0, 255, 76, 0.2); }
    .hud-screen.green .hud-title { color: var(--hud-green); text-shadow: 0 0 15px var(--hud-green); border-bottom: 2px solid var(--hud-green); }
    .hud-screen.gold { background-color: #080500; border: 1px solid rgba(255, 204, 0, 0.3); justify-content: center; align-items: center; }
    .orb-glow { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 250px; height: 250px; background: radial-gradient(circle, rgba(255,204,0,0.3) 0%, rgba(255,100,0,0.1) 40%, transparent 70%); border-radius: 50%; filter: blur(20px); animation: pulse 4s infinite alternate; }
    .main-val { font-family: var(--font-num); font-size: 2.2rem; font-weight: 700; letter-spacing: 1px; color: #fff; text-shadow: 0 0 10px rgba(255,255,255,0.3); }
    .total-val { font-family: var(--font-num); font-size: 3.5rem; font-weight: 700; color: #fff; text-shadow: 0 0 20px rgba(255,204,0,0.8); line-height: 1.1; }
    .pl-val { font-family: var(--font-num); font-size: 1.3rem; font-weight: bold; }
    .section-title { font-size: 1rem; border-left: 3px solid var(--gold); padding-left: 10px; margin: 25px 0 10px; font-weight: 900; color: #fff; display: flex; align-items: center; }
    .micro-card { background: var(--card); border: 2px solid #333; border-radius: 12px; padding: 8px; transition: all .3s; cursor: pointer; min-height: 200px; display: flex; flex-direction: column; position: relative; }
    .mc-media { width: 56px; height: 56px; object-fit: contain; }
    .lb-card-icon { width: 26px; height: 26px; object-fit: contain; }
    .color-profit { color: var(--red)!important; }
    .color-loss { color: var(--green)!important; }
    .color-gold { color: var(--gold)!important; }
    /* ... é¤˜ä¸‹æ¨£å¼æ‰¿è¥² v16.8 ... */
</style>
</head>
<body>
<div id="refresh-indicator"><div class="refresh-text"><div class="spinner"></div>REFRESHING...</div></div>
<header>
  <img id="pageLogo" src="" alt="Logo">
  <div class="header-text">
      <h1 id="pageTitle">LOADING...</h1>
      <div class="meta-info" id="pageMeta">LOADING...</div>
  </div>
</header>

<div class="container">
  <div class="dashboard-wrapper">
      <div class="dash-grid">
          <div class="hud-screen cyan">
              <div class="hud-title">TWD æˆ°æƒ… (å°å¹£)</div>
              <div class="data-group"><div class="cost-val" id="costTW">ç¸½æŠ•å…¥: ...</div></div>
              <div class="data-group"><div class="sub-label">å°è‚¡ç¾å€¼</div><div class="main-val c-cyan" id="assetTW">...</div></div>
              <div class="pl-block"><div class="sub-label">å³æ™‚æç›Š</div><div><span class="pl-val" id="plTW_val">...</span><span class="pl-pct" id="plTW_pct">...</span></div></div>
          </div>
          <div class="hud-screen green">
              <div class="hud-title">USD æˆ°æƒ… (ç¾é‡‘)</div>
              <div class="data-group"><div class="cost-val" id="costUS">ç¸½æŠ•å…¥: ...</div></div>
              <div class="data-group"><div class="sub-label">ç¾è‚¡ç¾å€¼</div><div class="main-val c-green" id="assetUS">...</div></div>
              <div class="pl-block"><div class="sub-label">æç›Šè¡¨ç¾</div><div><span class="pl-val" id="plUS_val">...</span><span class="pl-pct" id="plUS_pct">...</span></div></div>
          </div>
          <div class="hud-screen gold">
              <div class="orb-glow"></div>
              <div class="hud-title" style="margin-bottom:5px;">ç¸½åˆè³‡ç”¢ (TWDæ›ç®—)</div>
              <div class="total-val" id="totalAsset">...</div>
              <div class="total-sub">ç•¶å‰ç¶œåˆç¸¾æ•ˆ</div>
              <div style="position:absolute; bottom:15px; right:20px; color:#666; font-size:0.8rem; font-family:var(--font-num)" id="rateInfo">åŒ¯ç‡è¼‰å…¥ä¸­...</div>
          </div>
      </div>
  </div>

  <div class="section-title">I. LIVE BATTLE (æŠ•è³‡ç«¶æŠ€å ´)</div>
  <div class="arena-container" id="arenaContainer"></div>

  <div class="section-title">II. SKILL CARDS (ä¸ƒå¤§æŠ€èƒ½å¡ç‰Œ)</div>
  <div class="deck-wrapper"><div class="deck-grid" id="cardContainer"></div></div>

  <div class="section-title">III. EVENT LOG (äº‹ä»¶ç°¿)</div>
  <div class="event-list" id="eventContainer"></div>

  <div class="section-title">IV. IRON LAWS (æ ¸å¿ƒéµå¾‹)</div>
  <div class="footer-grid" id="footerContainer"></div>
</div>

<div id="cardModal" class="modal-overlay" onclick="closeModal()">
  <div class="modal-content" onclick="event.stopPropagation()">
    <div class="modal-header"><div><span class="m-code" id="mCode"></span><span class="m-skill" id="mSkill"></span></div><span class="close-btn" onclick="closeModal()">&times;</span></div>
    <div class="m-row"><span class="m-label">åˆå§‹é ç®— (CAPITAL)</span><div class="m-value highlight" id="val1"></div></div>
    <div class="m-row"><span class="m-label" style="color:var(--cyan)">ğŸ”¥ å¯¦éš›æŠ•å…¥ (INVESTED)</span><div class="m-value" id="val_invested" style="color:#00d2ff; font-weight:bold; font-family:'Courier New'"></div></div>
    <div class="m-row"><span class="m-label">æˆ°ç•¥å®šä½ (STRATEGY)</span><div class="m-value" id="val2"></div></div>
    <div class="m-row"><span class="m-label">åš´æ ¼åŸ·è¡Œ SOP</span><div class="m-value" id="val3" style="padding:15px;background:rgba(0,0,0,0.3);border-left:3px solid #555;border-radius:6px"></div></div>
  </div>
</div>

<script>
// ğŸ› ï¸ Google Drive è‡ªå‹•ä¿®å¾©é‚è¼¯ (é—œéµä¿®å¾©)
function fixDriveUrl(url) {
    if (!url) return '';
    if (url.includes('drive.google.com')) {
        const match = url.match(/(?:\/d\/|id=)([\w-]+)/);
        return match ? `https://drive.google.com/uc?export=view&id=${match[1]}` : url;
    }
    return url;
}

const GOOGLE_SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQuNQc8E7BlYLR5E6WlYHVQ3l_ki95CqcEcpS8sNQESRKcg5yECE-e2bgMvLGU-Vx5HFuWo5OS1GUIT/pub?output=tsv';

let currentRate = 32.5;
let cardsData = {}, portfolios = {}, strategiesData = {}, eventsData = [], lawsData = [];
let configData = { title: 'PROJECT CAGE', meta: 'v16.9' };
let logoUrl = '';

// åˆå§‹åŒ–ç³»çµ±
async function init() {
    try {
        const rateRes = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
        const rateData = await rateRes.json();
        if(rateData?.rates?.TWD) {
            currentRate = rateData.rates.TWD;
            document.getElementById('rateInfo').textContent = `å³æ™‚åŒ¯ç‡ USD/TWD: ${currentRate}`;
        }
    } catch (e) { console.warn('åŒ¯ç‡ API å¤±æ•—'); }

    try {
        const sheetRes = await fetch(GOOGLE_SHEET_URL + `&t=${Date.now()}`);
        const sheetText = await sheetRes.text();
        parseSheetData(sheetText);
        renderAll();
    } catch(e) { console.error('Sheet Loading Failed'); }
}

function parseSheetData(text){
  const rows = text.split('\n').map(r=>r.trim()); 
  let currentGroup = 'æœªåˆ†é¡', mode = 'CARDS'; 

  rows.forEach(row => {
    if(!row) return;
    const c = row.split('\t'); 
    if(c[0] === 'Title') { configData.title = c[1]; return; }
    if(c[0] === 'Meta') { configData.meta = c[1]; return; }
    if(c[0].startsWith('L')) { lawsData.push({ title: c[1], content: c[2] }); return; }
    if(c[0] === 'ä»£è™Ÿ' && c[1] === 'åç¨±') { mode = 'STRATEGIES'; return; }
    if(c[0] === 'äº‹ä»¶ç°¿') { mode = 'EVENTS'; return; }

    if(c[0].startsWith('C')) {
        let costRaw = c[5] || '0', curRaw = c[6] || '0', invRaw = c[13] || '0';
        // ğŸ› ï¸ é—œéµä¿®å¾©ï¼šæ ¹æ“š F æ¬„ä½æ˜¯å¦å« $ ä¸”æ’é™¤ NT ä¾†åˆ¤å®šç¾é‡‘é …ç›®
        let isUSD = costRaw.includes('$') && !costRaw.includes('NT$');
        let imgUrl = fixDriveUrl(c[9] ? c[9].trim() : '');
        
        cardsData[c[0]] = {
            code: c[0], type: c[1], rpg: c[2], target: c[3], skill: c[4],
            isUSD: isUSD,
            cost: parseFloat(costRaw.replace(/[NT$US,\s]/g, '')) || 0,
            current: parseFloat(curRaw.replace(/[NT$US,\s]/g, '')) || 0,
            invested: parseFloat(invRaw.replace(/[NT$US,\s]/g, '')) || 0,
            strategy: c[7], sop: c[8], imgUrl: imgUrl,
            media: imgUrl ? `<img src="${imgUrl}" class="mc-media">` : `<div class="mc-media" style="border:1px solid #333; line-height:56px">${c[0]}</div>`
        };
    } else if(c[0].startsWith('P')){
        if(!portfolios[currentGroup]) portfolios[currentGroup] = [];
        let sObj = { code: c[0], name: c[1], deck: c[2] ? c[2].split('+').map(s=>s.trim()) : [], mindset: c[3] || '-', persona: c[4] || '-', conflict: c[5] || '-' };
        portfolios[currentGroup].push(sObj); strategiesData[c[0]] = sObj;
    } else if (mode === 'STRATEGIES' && c[0] && !c[0].startsWith('P') && c.length < 5) {
        currentGroup = c[0].trim();
    } else if(mode === 'EVENTS' && c[0] && c[0].match(/^\d/)) {
        eventsData.push({ date: c[0], status: c[1] || 'Info', content: c[2] || '', isUrgent: (c[1] || '').includes('ç·Šæ€¥') });
    }
    if(c[0] === 'Logo' && c[1]) logoUrl = fixDriveUrl(c[1]);
  });
}

// ğŸ› ï¸ å ±é…¬ç‡è¨ˆç®—é‚è¼¯ä¿®å¾©
function calc(cost, cur){
  if(!cost) return {roi:0, arrow:'-', cls:'', diff: 0, sign: ''};
  const diff = cur - cost;
  const roiRaw = diff/cost;
  const roi = (roiRaw * 100).toFixed(1);
  let cls = roiRaw >= 0.5 ? 'color-gold' : roiRaw >= 0 ? 'color-profit' : roiRaw <= -0.5 ? 'color-dead' : 'color-loss';
  return {roi, arrow: diff>=0 ? 'â–²' : 'â–¼', sign: diff>=0 ? '+' : '', cls, diff};
}

function renderDashboard(){
  let tcTW=0, taTW=0, tcUS=0, taUS=0;
  Object.values(cardsData).forEach(c => {
      if(c.isUSD) { tcUS += c.cost; taUS += c.current; } 
      else { tcTW += c.cost; taTW += c.current; }
  });

  const sTW = calc(tcTW, taTW);
  document.getElementById('costTW').textContent = 'ç¸½æŠ•å…¥: NT$ ' + (tcTW/10000).toFixed(0) + 'è¬';
  document.getElementById('assetTW').textContent = taTW.toLocaleString();
  document.getElementById('plTW_val').textContent = `${sTW.sign}${sTW.diff.toLocaleString()}`;
  document.getElementById('plTW_val').className = `pl-val ${sTW.cls}`;
  document.getElementById('plTW_pct').textContent = `(${sTW.sign}${sTW.roi}%)`;

  const sUS = calc(tcUS, taUS);
  document.getElementById('costUS').textContent = 'ç¸½æŠ•å…¥: US$ ' + (tcUS/10000).toFixed(1) + 'è¬';
  document.getElementById('assetUS').textContent = '$' + taUS.toLocaleString();
  document.getElementById('plUS_val').textContent = `${sUS.sign}$${sUS.diff.toLocaleString()}`;
  document.getElementById('plUS_val').className = `pl-val ${sUS.cls}`;
  document.getElementById('plUS_pct').textContent = `(${sUS.sign}${sUS.roi}%)`;

  const totalAssetTWD = taTW + (taUS * currentRate);
  const totalCostTWD = tcTW + (tcUS * currentRate);
  const sTotal = calc(totalCostTWD, totalAssetTWD);
  document.getElementById('totalAsset').textContent = 'TWD ' + Math.round(totalAssetTWD).toLocaleString();
  document.getElementById('totalAsset').style.color = sTotal.roi >= 0 ? '#fff' : '#ffaaaa';
}

function renderArena(){
    const con = document.getElementById('arenaContainer'); con.innerHTML = ''; 
    let allS = [];
    Object.keys(portfolios).forEach(g => portfolios[g].forEach(p => {
        let tc = 0, ta = 0;
        p.deck.forEach(code => { 
            const c = cardsData[code]; 
            if (c) { 
                // ğŸ› ï¸ ç«¶æŠ€å ´ä¿®æ­£ï¼šå¦‚æœæ˜¯ç¾é‡‘å¡ï¼Œæ›ç®—æˆå°å¹£å†åŠ ç¸½ï¼Œå¦å‰‡ ROI æœƒéŒ¯
                tc += c.isUSD ? c.cost * currentRate : c.cost;
                ta += c.isUSD ? c.current * currentRate : c.current;
            } 
        });
        const res = calc(tc, ta);
        allS.push({ code: p.code, name: p.name, roiNum: parseFloat(res.roi), res, rawDeck: p.deck });
    }));
    allS.sort((a, b) => b.roiNum - a.roiNum);

    let html = `<div class="arena-dashboard-v15"><div class="leaderboard-panel"><div class="lb-header"><span>LIVE BATTLE</span><span>${allS.length} ENTRIES</span></div><div class="lb-list">`;
    allS.forEach((s, i) => {
        const deck = s.rawDeck.map(code => {
            const card = cardsData[code];
            return card?.imgUrl ? `<img src="${fixDriveUrl(card.imgUrl)}" class="lb-card-icon">` : `<div class="lb-card-icon" style="background:#222;font-size:8px;">${code}</div>`;
        }).join('');
        html += `<div class="lb-row rank-${i+1}" onclick="openStrategyModal('${s.code}')"><span class="lb-rank">#${i+1}</span><div class="lb-info"><div class="lb-name">${s.name}</div><div class="lb-code">${s.code}</div></div><div class="lb-deck">${deck}</div><span class="lb-val ${s.res.cls}">${s.res.sign}${s.res.roi}%</span></div>`;
    });
    
    let maxR = Math.max(...allS.map(x => Math.abs(x.roiNum)), 10);
    con.innerHTML = html + `</div></div><div class="chart-panel"><div class="chart-grid"></div>` + 
    allS.slice(0, 13).map(s => {
        let h = (Math.abs(s.roiNum) / (maxR * 1.2)) * 100;
        let color = s.res.cls === 'color-profit' ? 'var(--red)' : (s.res.cls==='color-gold'?'var(--gold)':'var(--green)');
        return `<div class="bar-wrapper"><div class="bar-fill" style="height:${h}%; background:${color}; box-shadow: 0 0 10px ${color}"><span class="bar-val-top">${s.res.roi}%</span></div><div class="bar-label-bottom">${s.code}</div></div>`;
    }).join('') + `</div></div>`;
}

function renderCards(){
    const con=document.getElementById('cardContainer'); con.innerHTML='';
    Object.values(cardsData).forEach(c=>{
        con.innerHTML+=`<div class="micro-card ${c.type}" onclick="openModal('${c.code}')"><div class="mc-header"><span class="mc-code">${c.code}</span><span class="mc-target">${c.target}</span></div><div class="mc-image-container">${c.media}</div><div class="mc-footer"><div class="mc-chn-name">${c.rpg||''}</div><div class="mc-eng-name">${c.skill}</div><div class="mc-cost-badge">$${(c.cost/10000).toFixed(0)}è¬</div></div></div>`;
    });
}
function renderEvents(){ const con = document.getElementById('eventContainer'); con.innerHTML = eventsData.slice(0, 2).map(e => `<div class="event-card${e.isUrgent?' emergency':''}"><div class="event-header"><span class="event-date">${e.date}</span><span class="event-status">${e.status}</span></div><div class="event-content">${e.content}</div></div>`).join(''); }
function renderFooter() { const con = document.getElementById('footerContainer'); con.innerHTML = lawsData.map(law => `<div class="info-box"><span class="info-title">${law.title}</span>${law.content}</div>`).join('') + `<div class="info-box refresh-btn" onclick="init()">â†» REFRESH DATA</div>`; }
function openModal(k){ const c=cardsData[k]; document.getElementById('mCode').textContent=c.code; document.getElementById('mSkill').textContent=c.skill; document.getElementById('val1').textContent = `${c.isUSD?'US$':'NT$'} ${c.cost.toLocaleString()}`; document.getElementById('val_invested').textContent = `${c.isUSD?'US$':'NT$'} ${c.invested.toLocaleString()}`; document.getElementById('val2').textContent = c.strategy; document.getElementById('val3').textContent = c.sop; document.getElementById('cardModal').style.display='flex'; document.getElementById('cardModal').classList.add('modal-active'); }
function openStrategyModal(k) { const s = strategiesData[k]; document.getElementById('mCode').textContent = s.code; document.getElementById('mSkill').textContent = s.name; document.getElementById('val1').textContent = s.mindset; document.getElementById('val_invested').textContent = '-'; document.getElementById('val2').textContent = s.persona; document.getElementById('val3').textContent = s.conflict; document.getElementById('cardModal').style.display = 'flex'; document.getElementById('cardModal').classList.add('modal-active'); }
function closeModal(){document.getElementById('cardModal').style.display='none'}
function renderHeader() { const img = document.getElementById('pageLogo'); if (logoUrl) { img.src = logoUrl; img.style.display = 'block'; } document.getElementById('pageTitle').textContent = configData.title; document.getElementById('pageMeta').textContent = configData.meta; }
function renderAll(){ renderHeader(); renderDashboard(); renderCards(); renderEvents(); renderArena(); renderFooter(); }

init();
</script>
</body>
</html>
